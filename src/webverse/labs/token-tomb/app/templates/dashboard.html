{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-end justify-content-between mb-4">
  <div>
    <h1 class="h3 mb-1">Operations Overview</h1>
    <div class="text-secondary">Live PulsePay metrics for the last 90 days.</div>
  </div>
  <span class="badge pp-badge">Console</span>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="pp-card p-3">
      <div class="text-secondary small">Active users</div>
      <div id="mActiveUsers" class="h3 mb-0">—</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="pp-card p-3">
      <div class="text-secondary small">Total processed (90d)</div>
      <div id="mProcessed" class="h3 mb-0">—</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="pp-card p-3">
      <div class="text-secondary small">Risk status</div>
      <div class="h3 mb-0">Normal</div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-7">
    <div class="pp-card p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="h5 mb-0">Users by country</div>
          <div class="text-secondary small">Distribution of active console sessions</div>
        </div>
      </div>
      <canvas id="countryChart" height="160"></canvas>

      <div class="mt-3 small text-secondary">
        <span class="pp-legend-dot" style="background:#ff3b3b;"></span> USA
        <span class="pp-legend-dot" style="background:#3b6cff;"></span> Russia
        <span class="pp-legend-dot" style="background:#ffd400;"></span> France
        <span class="pp-legend-dot" style="background:#28d17c;"></span> Canada
        <span class="pp-legend-dot" style="background:#b07cff;"></span> Japan
        <span class="pp-legend-dot" style="background:#ff8a3b;"></span> Brazil
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="pp-card p-3">
      <div class="h5 mb-1">System notes</div>
      <div class="text-secondary small mb-3">
        PulsePay is piloting new cross-border settlement rails and partner integrations.
      </div>

      <div class="pp-note">
        Monitor abnormal merchant bursts. Review dispute batches daily.
      </div>
    </div>
  </div>
</div>

<script>
(async function () {
  const res = await fetch("/api/v1/metrics", { credentials: "include" });
  if (!res.ok) return;
  const data = await res.json();

  document.getElementById("mActiveUsers").textContent = data.active_users;
  document.getElementById("mProcessed").textContent = "$" + data.processed_90d_usd.toLocaleString("en-US");

  const labels = Object.keys(data.countries);
  const values = Object.values(data.countries);

  new Chart(document.getElementById("countryChart"), {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: ["#ff3b3b", "#3b6cff", "#ffd400", "#28d17c", "#b07cff", "#ff8a3b"]
      }]
    },
    options: {
      plugins: {
        legend: { display: false }
      }
    }
  });
})();
</script>
{% endblock %}
